/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","fin/ap/process/payments/lib/Messages","fin/ap/process/payments/lib/Constants","fin/ap/process/payments/lib/Formatters","fin/ap/process/payments/ext/controller/Dialog","fin/ap/process/payments/ext/controller/Actions","sap/ui/generic/app/transaction/TransactionController","sap/m/Dialog","sap/m/Button","sap/m/Text","jquery.sap.promise"],function(P,M,C,F,D,A,T,a,B,b){"use strict";var c=P.extend("fin.ap.process.payments.ext.controller.Footer",{constructor:function(v,r){var d;this.messages=M;this.formatter=F;this.view=function(){return v;};this.resourceBundle=function(){return r;};d=new A(this.view(),this.resourceBundle());this.actions=function(){return d;};}});c.prototype.initFooter=function(){var d=this.view().getContent();var f=d[0].getFooter();var e=this.createActionButtons();f.bindProperty("visible",{parts:[{path:"StatusCode"},{path:"message>/"},{path:"ui>/editable"}],formatter:this.formatter.footerVisible.bind(this.formatter)});e.forEach(function(g){f.addContent(g);});};c.prototype.createActionButtons=function(){var h=[this.handlePostAndReleasePress.bind(this),this.handleReleasePress.bind(this),this.handlePostPress.bind(this),this.handleReversePress.bind(this)];return C.BUTTON_CONFIGS.map(function(d,i){d.settings.type=sap.m.ButtonType[d.settings.type];d.settings.text=this.resourceBundle().getText(d.settings.text);d.settings.press=this.handleActionButtonPress.bind(this,h[i],d.settings.text);return this.createActionButton(d);}.bind(this));};c.prototype.createActionButton=function(d){var e;var i=this.getModel("btnModel").getProperty("/"+d.id);if(!i){return null;}e=this.createButton(d.id,d.settings);e.bindProperty("visible",{parts:[{path:"StatusCode"},{path:"ui>/editable"}],formatter:this.formatter.isPaymentActionEnabled.bind(this.formatter,d.statuses)});return e;};c.prototype.createButton=function(n,s){var i=this.view().getId()+"--"+n;var d=this.byId(i);return d?d:new sap.m.Button(i,s);};c.prototype.handleActionButtonPress=function(h,d){var e;var u;this.rebindEntity().then(function(f){if(this.isDraftLockedByAnotherUser(f)){u=this.getDraftProcessUser(f);e=this.resourceBundle().getText("DRAFT_LOCKED_ERROR",[d.toLowerCase(),u]);this.showErrorDialog(e);}else if(this.isDraftExpiredByAnotherUser(f)){u=this.getDraftLastProcessUser(f);e=this.resourceBundle().getText("DRAFT_DISCARD_WARNING",u);this.showErrorDialog(e,{text:this.resourceBundle().getText("DISCARD"),handler:this.discardDraft.bind(this)});}else{h();}}.bind(this));};c.prototype.discardDraft=function(){var d=this.view().getBindingContext();return this.getTransactionController().deleteEntity(d).then(function(){return this.rebindEntity();}.bind(this));};c.prototype.getDraftProcessUser=function(e){var d=e.data.DraftAdministrativeData;return d!==undefined&&d.InProcessByUserDescription;};c.prototype.getDraftLastProcessUser=function(e){var d=e.data.DraftAdministrativeData;return d!==undefined&&d.LastChangedByUserDescription;};c.prototype.isDraftLockedByAnotherUser=function(e){var d=e.data.DraftAdministrativeData;return d!==undefined&&d.InProcessByUser!==""&&!d.DraftIsProcessedByMe;};c.prototype.isDraftExpiredByAnotherUser=function(e){var d=e.data.DraftAdministrativeData;return d!==undefined&&d.InProcessByUser===""&&!d.DraftIsLastChangedByMe;};c.prototype.rebindEntity=function(){var d=this.createBindingPromise();var e=this.getEntityBinding();e.refresh(true);return d;};c.prototype.createBindingPromise=function(){var d;var e=this.getEntityBinding();e.attachEventOnce("dataRequested",null,function(f){d=f.getSource()["mParameters"];if(d.expand===""){d.expand="DraftAdministrativeData";}else{d.expand+=",DraftAdministrativeData";}});return new Promise(function(r){e.attachEventOnce("dataReceived",null,function(f){r(f.getParameters());});});};c.prototype.getEntityBinding=function(){var p=this.view().getBindingContext().getPath();return this.view().getModel().aBindings.filter(function(i){return i.getPath()===p;})[0];};c.prototype.handleReleasePress=function(){this.openDialog(C.ACTIONS.RELEASE.title,C.ACTIONS.RELEASE.message,false,this.onReleasePress.bind(this));};c.prototype.handleReversePress=function(){var d=this.openDialog(C.ACTIONS.REVERSE.title,C.ACTIONS.REVERSE.message,true,this.onReversePress.bind(this));this.fillSelect(d);};c.prototype.handlePostPress=function(){this.openDialog(C.ACTIONS.POST.title,C.ACTIONS.POST.message,false,this.onPostPress.bind(this));};c.prototype.handlePostAndReleasePress=function(){this.openDialog(C.ACTIONS.POST_AND_RELEASE.title,C.ACTIONS.POST_AND_RELEASE.message,false,this.onPostAndReleasePress.bind(this));};c.prototype.openDialog=function(t,m,i,d){var e;var p=this.getBindingContext().getProperty("PaymentRequest");var f=this.resourceBundle().getText(t);var g=this.resourceBundle().getText(m,p);this.getModel("dialog").setProperty("/title",f);this.getModel("dialog").setProperty("/message",g);this.getModel("dialog").setProperty("/isReverse",i);e=this.createDialog(d);e.showDialog();return e;};c.prototype.onReleasePress=function(){this.actions().performAction(C.ACTIONS.RELEASE.name);};c.prototype.onReversePress=function(){this.actions().performAction(C.ACTIONS.REVERSE.name);};c.prototype.onPostPress=function(){this.actions().performAction(C.ACTIONS.POST.name);};c.prototype.onPostAndReleasePress=function(){this.actions().performAction(C.ACTIONS.POST_AND_RELEASE.name);};c.prototype.fillSelect=function(d){d.fragment().setBusy(true);return this.actions().getReversalReasons().then(function(e){this.bindSelectItems(e.results);}.bind(this)).catch().then(function(){d.fragment().setBusy(false);});};c.prototype.bindSelectItems=function(i){var s=this.byId("reasonSelect");var m=new sap.ui.model.json.JSONModel({"items":i});var t=new sap.ui.core.Item({key:"{ReversalReason}",text:{parts:[{path:"ReversalReason"},{path:"ReversalReasonName"}],formatter:this.formatter.formatReason}});var d=new sap.ui.model.Sorter("ReversalReason");s.setModel(m);s.bindItems({path:"/items",template:t,sorter:d});};c.prototype.showErrorDialog=function(t,d){var e=new a({title:"Warning",type:"Message",state:"Warning",content:new b({text:t}),endButton:new B({text:this.resourceBundle().getText("CLOSE"),press:function(){e.close();}})});if(d){e.setBeginButton(new B({text:d.text,press:function(){d.handler();e.close();}}));}e.open();};c.prototype.getTransactionController=function(){if(!this.transactionController){this.transactionController=new T(this.getModel());}return this.transactionController;};c.prototype.createDialog=function(d){return new D(this.view(),d);};c.prototype.getBindingContext=function(){return this.view().getBindingContext();};c.prototype.getModel=function(i){return this.view().getModel(i);};c.prototype.byId=function(i){return this.view().byId(i);};return c;});
